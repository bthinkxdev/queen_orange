{% extends "base.html" %}
{% load static %}
{% block title %}Checkout - Queen Orange{% endblock %}
{% block meta_description %}Complete your order with delivery details.{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/auth.css' %}">
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}

{% block content %}
    <section class="checkout-page">
        <div class="container">
            <div class="section-header" style="margin-bottom: 40px;">
                <h1 class="section-title">Checkout</h1>
                <p class="section-subtitle">Complete your order details</p>
            </div>

            <div class="checkout-container">
                <div class="checkout-form">
                    {% if form.errors %}
                        <div class="notification error" style="position: relative; opacity: 1; margin-bottom: 24px;">
                            {% if form.non_field_errors %}
                                {{ form.non_field_errors.0 }}
                            {% else %}
                                Please review the highlighted fields.
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <form method="post" action="{% url 'store:order_create' %}" id="checkoutForm">
                        {% csrf_token %}
                        {{ form.selected_address }}
                        {{ form.use_new_address }}
                        
                        <!-- Saved Addresses Section -->
                        {% if addresses %}
                        <div class="form-section">
                            <div class="section-header-inline">
                                <h3>Delivery Address</h3>
                                <button type="button" class="btn-link" id="addNewAddressBtn">+ Add New Address</button>
                            </div>
                            
                            <div class="saved-addresses" id="savedAddresses">
                                {% for address in addresses %}
                                <label class="address-card selectable {% if address.is_default and not form.is_bound %}selected{% elif form.selected_address.value == address.pk|stringformat:"s" %}selected{% endif %}">
                                    <input type="radio" name="address_selection" value="{{ address.pk }}" 
                                           {% if address.is_default and not form.is_bound %}checked{% elif form.selected_address.value == address.pk|stringformat:"s" %}checked{% endif %}>
                                    <div class="address-card-content">
                                        {% if address.is_default %}
                                            <span class="default-badge">Default</span>
                                        {% endif %}
                                        <div class="address-info">
                                            <strong>{{ address.full_name }}</strong>
                                            <p>{{ address.phone }}</p>
                                            <p>{{ address.address_line }}</p>
                                            <p>{{ address.city }}, {{ address.state }} - {{ address.pincode }}</p>
                                        </div>
                                        <div class="address-checkmark">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </div>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- New Address Form -->
                        <div class="form-section" id="newAddressSection" {% if addresses and not form.is_bound %}style="display: none;"{% endif %}>
                            <div class="section-header-inline">
                                <h3>{% if addresses %}Add New Address{% else %}Delivery Address{% endif %}</h3>
                                {% if addresses %}
                                <button type="button" class="btn-link" id="cancelNewAddressBtn">Cancel</button>
                                {% endif %}
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_full_name">Full Name *</label>
                                    {{ form.full_name }}
                                    {% if form.full_name.errors %}
                                        <span class="form-error">{{ form.full_name.errors.0 }}</span>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label for="id_phone">Phone Number *</label>
                                    {{ form.phone }}
                                    {% if form.phone.errors %}
                                        <span class="form-error">{{ form.phone.errors.0 }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_address_line">Address *</label>
                                {{ form.address_line }}
                                {% if form.address_line.errors %}
                                    <span class="form-error">{{ form.address_line.errors.0 }}</span>
                                {% endif %}
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_city">City *</label>
                                    {{ form.city }}
                                    {% if form.city.errors %}
                                        <span class="form-error">{{ form.city.errors.0 }}</span>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label for="id_pincode">Pincode *</label>
                                    {{ form.pincode }}
                                    {% if form.pincode.errors %}
                                        <span class="form-error">{{ form.pincode.errors.0 }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_state">State *</label>
                                {{ form.state }}
                                {% if form.state.errors %}
                                    <span class="form-error">{{ form.state.errors.0 }}</span>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="id_email">Email (Optional)</label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <span class="form-error">{{ form.email.errors.0 }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="form-section">
                            <h3>Payment Method</h3>
                            <div class="payment-options">
                                <label class="payment-option {% if form.payment.value == 'cod' %}selected{% endif %}">
                                    <input type="radio" name="payment" value="cod" {% if form.payment.value == 'cod' %}checked{% endif %}>
                                    <div class="payment-option-content">
                                        <div class="payment-checkbox">
                                            <svg class="checkmark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </div>
                                        <div class="payment-details">
                                            <strong>Cash on Delivery</strong>
                                            <p>Pay when you receive your order</p>
                                        </div>
                                    </div>
                                </label>

                                {% comment %} <label class="payment-option {% if form.payment.value == 'whatsapp' %}selected{% endif %}">
                                    <input type="radio" name="payment" value="whatsapp" {% if form.payment.value == 'whatsapp' %}checked{% endif %}>
                                    <div class="payment-option-content">
                                        <div class="payment-checkbox">
                                            <svg class="checkmark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </div>
                                        <div class="payment-details">
                                            <strong>WhatsApp Order</strong>
                                            <p>Complete order via WhatsApp chat</p>
                                        </div>
                                    </div>
                                </label> {% endcomment %}

                                <label class="payment-option {% if form.payment.value == 'razorpay' or not form.is_bound %}selected{% endif %}">
                                    <input type="radio" name="payment" value="razorpay" {% if form.payment.value == 'razorpay' or not form.is_bound %}checked{% endif %}>
                                    <div class="payment-option-content">
                                        <div class="payment-checkbox">
                                            <svg class="checkmark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </div>
                                        <div class="payment-details">
                                            <strong>Online Payment</strong>
                                            <p>Secure online payment</p>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-full" style="margin-top: 32px;">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                            </svg>
                            <span>Place Order</span>
                        </button>
                    </form>
                </div>

                <!-- Order Summary -->
                <div class="order-summary cart-summary">
                    <h3>Order Summary</h3>
                    <div class="order-items">
                        {% for item in items %}
                            <div class="order-item">
                                <div class="order-item-image">
                                    {% with image=item.product.images.first %}
                                        {% if image %}
                                            <img src="{{ image.image.url }}" alt="{{ item.product.name }}">
                                        {% else %}
                                            <img src="{% static 'images/banner.png' %}" alt="{{ item.product.name }}">
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="order-item-info">
                                    <div class="order-item-name">{{ item.product.name }}</div>
                                    <div class="order-item-meta">Size: {{ item.variant.size }} | Qty: {{ item.quantity }}</div>
                                    <div class="order-item-price">₹{{ item.line_total }}</div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span>₹{{ totals.subtotal }}</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping</span>
                        <span>{% if totals.shipping == 0 %}FREE{% else %}₹{{ totals.shipping }}{% endif %}</span>
                    </div>
                    <div class="summary-row total-row">
                        <span>Total</span>
                        <span>₹{{ totals.total }}</span>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/checkout.js' %}"></script>
{% endblock %}
