{% extends "admin/base.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-shopping-bag"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Total Orders</div>
            <div class="stat-value">{{ total_orders }}</div>
            <div class="stat-change">{{ orders_today }} today</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-rupee-sign"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value">₹{{ total_revenue|floatformat:0 }}</div>
            <div class="stat-change">₹{{ revenue_today|floatformat:0 }} today</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fas fa-box"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Products</div>
            <div class="stat-value">{{ total_products }}</div>
            <div class="stat-change">{{ low_stock_products }} low stock</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon danger">
            <i class="fas fa-envelope"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Messages</div>
            <div class="stat-value">{{ unresolved_messages }}</div>
            <div class="stat-change">Unresolved</div>
        </div>
    </div>
</div>

<!-- Order Status Summary -->
<div class="card mb-3">
    <div class="card-header">
        <h3 class="card-title">Order Status Summary</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
            {% for status in order_status %}
                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                    <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">
                        {{ status.status|title }}
                    </div>
                    <div style="font-size: 1.75rem; font-weight: 700; color: var(--primary);">
                        {{ status.count }}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Revenue Chart -->
<div class="card mb-3">
    <div class="card-header">
        <h3 class="card-title">Revenue Trend (Last 14 Days)</h3>
    </div>
    <div class="card-body">
        <canvas id="revenueChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<!-- Two Column Layout -->
<div class="grid-2">
    <!-- Recent Orders -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Recent Orders</h3>
            <a href="{% url 'admin_panel:order_list' %}" class="btn btn-sm btn-secondary">View All</a>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if recent_orders %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                                <tr>
                                    <td>
                                        <a href="{% url 'admin_panel:order_detail' order.order_number %}" 
                                           style="color: var(--primary); text-decoration: none; font-weight: 500;">
                                            {{ order.order_number }}
                                        </a>
                                    </td>
                                    <td>{{ order.address.full_name|truncatechars:20 }}</td>
                                    <td>₹{{ order.total }}</td>
                                    <td>
                                        {% if order.status == 'placed' %}
                                            <span class="badge badge-info">{{ order.get_status_display }}</span>
                                        {% elif order.status == 'confirmed' %}
                                            <span class="badge badge-warning">{{ order.get_status_display }}</span>
                                        {% elif order.status == 'delivered' %}
                                            <span class="badge badge-success">{{ order.get_status_display }}</span>
                                        {% elif order.status == 'cancelled' %}
                                            <span class="badge badge-danger">{{ order.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge badge-secondary">{{ order.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-shopping-bag"></i>
                    <p>No orders yet</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Top Products -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Top Selling Products</h3>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if top_products %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Sold</th>
                                <th>Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in top_products %}
                                <tr>
                                    <td>{{ product.name|truncatechars:30 }}</td>
                                    <td>{{ product.total_sold }} units</td>
                                    <td>₹{{ product.revenue|floatformat:0 }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-box"></i>
                    <p>No sales data yet</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="card mt-3">
    <div class="card-header">
        <h3 class="card-title">Quick Stats</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
            <div>
                <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">Orders This Week</div>
                <div style="font-size: 1.5rem; font-weight: 600;">{{ orders_this_week }}</div>
            </div>
            <div>
                <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">Revenue This Week</div>
                <div style="font-size: 1.5rem; font-weight: 600;">₹{{ revenue_this_week|floatformat:0 }}</div>
            </div>
            <div>
                <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">Orders This Month</div>
                <div style="font-size: 1.5rem; font-weight: 600;">{{ orders_this_month }}</div>
            </div>
            <div>
                <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">Revenue This Month</div>
                <div style="font-size: 1.5rem; font-weight: 600;">₹{{ revenue_this_month|floatformat:0 }}</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Revenue Chart
    const chartData = JSON.parse('{{ chart_data|escapejs }}');
    const ctx = document.getElementById('revenueChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.map(d => d.date),
            datasets: [{
                label: 'Revenue (₹)',
                data: chartData.map(d => d.revenue),
                borderColor: '#6D4C41',
                backgroundColor: 'rgba(109, 76, 65, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₹' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}

